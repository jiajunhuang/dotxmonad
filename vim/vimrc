silent function! s:WINDOWS()
    return (has("win32") || has("win64"))
endfunction

silent function! s:LINUX()
    return (has('unix') && !has('macunix') && !has('win32unix'))
endfunction

silent function! s:NVIM()
    return (has('nvim'))
endfunction

silent function! s:ASYNC()
    return ((v:version >= 800) || s:NVIM())
endfunction

if s:LINUX()
    if s:NVIM()
        let VIM_PLUG_HOME = '~/.config/nvim/plugged'
    else
        let VIM_PLUG_HOME = '~/.vim/plugged'
    endif
else
    let VIM_PLUG_HOME = '~\vimfiles\plugged'
endif

call plug#begin(VIM_PLUG_HOME)

" plugins
" language specific: syntax, or indent or something else
Plug 'hynek/vim-python-pep8-indent'
Plug 'itchyny/vim-haskell-indent'
Plug 'stephpy/vim-yaml'

" utils
Plug 'airblade/vim-gitgutter'
Plug 'cohama/agit.vim'
Plug 'jiangmiao/auto-pairs'
Plug 'justinmk/vim-sneak'
Plug 'majutsushi/tagbar'
Plug 'mbbill/undotree'
Plug 'mileszs/ack.vim'
Plug 'othree/eregex.vim'
Plug 'scrooloose/nerdcommenter'
Plug 'scrooloose/nerdtree'
Plug 'terryma/vim-multiple-cursors'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-rhubarb'
Plug 'tpope/vim-rsi'
Plug 'tpope/vim-sensible'
Plug 'tpope/vim-surround'
Plug 'uber/prototool', {'rtp':'vim/prototool'}
Plug 'rust-lang/rust.vim'

" look and feel
Plug 'itchyny/lightline.vim'
Plug 'kshenoy/vim-signature'
Plug 'luochen1990/rainbow'
Plug 'ntpeters/vim-better-whitespace'
Plug 'sickill/vim-monokai'

" Linux only
if s:LINUX()
    " utils
    Plug 'Valloric/YouCompleteMe'
    Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all'  } | Plug 'junegunn/fzf.vim'
    Plug 'tpope/vim-eunuch'

    " language specific
    Plug 'vim-jp/vim-go-extra'

    " syntax check
    if s:ASYNC()
        " Go: golint(https://github.com/golang/lint)
        Plug 'w0rp/ale'
    else
        Plug 'vim-syntastic/syntastic'
    endif
endif

if s:WINDOWS()
    Plug 'mhinz/vim-startify'
    Plug 'jiajunhuang/gvim.vim'
endif

call plug#end()

" settings
"syntax
syntax on
syntax enable

" display
set ignorecase
set ruler
set number
set showcmd
set showmode
set cursorline cursorcolumn
set colorcolumn=120
set wrap
set textwidth=0

"display pairs
set showmatch

"indent
set expandtab
set shiftwidth=4
set tabstop=4
set softtabstop=4
set cindent
set shiftround

"Tab
set smarttab

" colorscheme, default to monokai, fallback to desert
try
    colorscheme monokai
catch /^Vim\%((\a\+)\)\=:E185/
    colorscheme desert
endtry

" shortcuts
" paste mode
set pastetoggle=<F2>

" toggle number
noremap <F4> :set invnumber<CR>
inoremap <F4> <C-O>:set invnumber<CR>

" tagbar
nmap <F8> :TagbarToggle<CR>
" install `gotags` frist
let g:tagbar_type_go = {
	\ 'ctagstype' : 'go',
	\ 'kinds'     : [
		\ 'p:package',
		\ 'i:imports:1',
		\ 'c:constants',
		\ 'v:variables',
		\ 't:types',
		\ 'n:interfaces',
		\ 'w:fields',
		\ 'e:embedded',
		\ 'm:methods',
		\ 'r:constructor',
		\ 'f:functions'
	\ ],
	\ 'sro' : '.',
	\ 'kind2scope' : {
		\ 't' : 'ctype',
		\ 'n' : 'ntype'
	\ },
	\ 'scope2kind' : {
		\ 'ctype' : 't',
		\ 'ntype' : 'n'
	\ },
	\ 'ctagsbin'  : 'gotags',
	\ 'ctagsargs' : '-sort -silent'
\ }

" nerdtree
nmap <F3> :NERDTreeToggle<CR>

" make mouse only works on command line mode
set mouse=c

" use Ctrl + hjkl to move left, down, up, right
nnoremap <C-H> <C-W>h
nnoremap <C-L> <C-W>l
nnoremap <C-J> <C-W>j
nnoremap <C-K> <C-W>k

" resize
nnoremap <Up> <C-W>-2
nnoremap <Down> <C-W>+2
nnoremap <Left> <C-W><2
nnoremap <Right> <C-W>>2

" preview substitute
if s:NVIM()
    set inccommand=nosplit
    tnoremap <Esc> <C-\><C-n>
    nnoremap <C-s> <Esc>:vsplit term://bash<CR>A
    nnoremap <C-x> <Esc>:split term://bash<CR>A
endif

" python
nnoremap <leader>d Oimport pdb; pdb.set_trace()<Esc>

" persistent
set undodir=~/.cache/vimundo/
set undofile

" plugin settings
" Rainbow
let g:rainbow_active = 1

" Linux only
if s:LINUX()
    " fzf
    nnoremap <C-p> :Files<CR>
    nnoremap <leader>b :Buffers<CR>
    nnoremap <leader>m :Marks<CR>
    nnoremap <leader>a :Ag<CR>
    nnoremap ff :BLines<CR>

    " YouCompleteMe
    let g:ycm_seed_identifiers_with_syntax = 1
    let g:ycm_autoclose_preview_window_after_insertion = 1
    nnoremap <leader>\ :YcmCompleter GoTo<CR>

    if s:NVIM()
        " terminal
        nnoremap <leader>t :vsplit term://bash<CR>
        nnoremap <leader>T :split term://bash<CR>
    endif

    " vim-sneak
    let g:sneak#label = 1

    if s:ASYNC()
        nmap <leader>p <Plug>(ale_previous_wrap)
        nmap <leader>n <Plug>(ale_next_wrap)

        let g:ale_linters = {'proto': ['prototool']}
    endif
endif
